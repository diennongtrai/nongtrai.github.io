<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESP32 MQTT Dashboard</title>
  <style>
    body { font-family: Arial; background: #f0f0f0; padding: 20px; }
    .status { margin-bottom: 20px; }
    .sensor-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .sensor-box {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 5px #ccc;
      width: 30%;
      min-width: 250px;
      flex-grow: 1;
    }
    .sensor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }
    .sensor-header i {
      font-size: 20px;
      color: #007bff;
      margin-right: 5px;
    }
    .led-icon {
      font-size: 28px;
      transition: all 0.3s;
    }
    .led-on { color: #28a745; }
    .led-off { color: #ccc; }
    .data-row {
      margin-top: 10px;
      line-height: 1.8em;
      display: flex;
      align-items: center;
    }
    .data-row i {
      margin-right: 8px;
      width: 20px;
      text-align: center;
      color: #333;
    }
    .data-row b {
     color: #d9534f;
    }
    .time-row {
      font-size: 0.9em;
      color: #666;
      margin-top: 8px;
    }
    button {
      padding: 5px 12px;
      margin: 3px;
    }
    .online { color: green; }
    .offline { color: red; }
    #history {
      margin-top: 30px;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 5px #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th { background-color: #f9f9f9; }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

  <h2>ESP32 MQTT Dashboard</h2>
  <div class="status">
    <b>MQTT:</b> <span id="mqttStatus" class="offline">Ch∆∞a k·∫øt n·ªëi</span><br>
    <b>WiFi:</b> <span id="wifiStatus" class="offline">ƒêang ki·ªÉm tra...</span>
  </div>

  <div class="sensor-grid" id="sensorContainer"></div>

  <div id="history">
    <h3>L·ªãch s·ª≠ d·ªØ li·ªáu</h3>
    <button onclick="downloadCSV()">T·∫£i v·ªÅ CSV</button>
    <button onclick="exportExcelBillToServer()">üìÑ L∆∞u Bill l√™n Server</button>
    <table>
      <thead>
        <tr>
          <th>Th·ªùi gian</th>
          <th>Thi·∫øt b·ªã</th>
          <th>Th√¥ng s·ªë</th>
          <th>Gi√° tr·ªã</th>
          <th>LED</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
  const mqttStatus = document.getElementById("mqttStatus");
  const wifiStatus = document.getElementById("wifiStatus");
  const sensorContainer = document.getElementById("sensorContainer");
  const historyTable = document.getElementById("historyTable");
  const sensors = ["sensor_1", "sensor_2", "sensor_3"];
  const historyRows = [];
  
  sensors.forEach(device => {
    let dataRows = '';
    if (device === "sensor_3") {
      dataRows = `
        <div class="data-row"><i class="fas fa-bolt"></i> Voltage: <span id="voltage_${device}">-</span></div>
        <div class="data-row"><i class="fas fa-battery-three-quarters"></i> Current: <span id="current_${device}">-</span></div>
        <div class="data-row"><i class="fas fa-plug"></i> Power: <span id="power_${device}">-</span></div>
        <div class="data-row"><i class="fas fa-tachometer-alt"></i> Energy: <span id="energy_${device}">-</span></div>
      `;
    } else {
      dataRows = `
        <div class="data-row"><i class="fas fa-running"></i> Moving: <span id="moving_${device}">-</span></div>
        <div class="data-row"><i class="fas fa-user"></i> Stationary: <span id="stationary_${device}">-</span></div>
      `;
    }
    const html = `
      <div class="sensor-box" id="box_${device}">
        <div class="sensor-header">
          <span><i class="fas fa-microchip"></i> ${device.replace('_', ' ').toUpperCase()}</span>
          <i id="icon_${device}" class="fas fa-toggle-off led-icon led-off"></i>
        </div>
        ${dataRows}
        <div class="data-row"><i class="fas fa-lightbulb"></i> LED: <span id="led_${device}">-</span></div>
        <div class="time-row">C·∫≠p nh·∫≠t: <span id="time_${device}">--:--:--</span></div>
        ${device === "sensor_3" ? `
          <div class="time-row">Ng√†y ch·ªët ƒëi·ªán: <span id="billing_date_sensor_3">--</span></div>
          <div class="time-row">S·∫£n l∆∞·ª£ng th√°ng: <span id="monthly_energy_sensor_3">--</span></div>
          <div class="time-row">Ch·ªâ s·ªë ƒë·∫ßu k·ª≥ th√°ng n√†y: <span id="start_energy_current">--</span></div>
          <div class="time-row">Ch·ªâ s·ªë ƒë·∫ßu k·ª≥ th√°ng tr∆∞·ªõc: <span id="start_energy_prev">--</span></div>
        ` : ''}
        <button onclick="controlLed('${device}', 1)">B·∫≠t</button>
        <button onclick="controlLed('${device}', 0)">T·∫Øt</button>
      </div>`;
    sensorContainer.insertAdjacentHTML('beforeend', html);
  });

   const client = mqtt.connect("wss://5535a388c0214921bd01737fcf390158.s1.eu.hivemq.cloud:8884/mqtt", {
    username: "Famer_smarthome123",
    password: "@Tmh12345678"
  });

  client.on("connect", () => {
    mqttStatus.textContent = "\u0110\u00e3 k\u1ebft n\u1ed1i";
    mqttStatus.className = "online";
    sensors.forEach(topic => client.subscribe(topic + "/control"));
  });

  client.on("message", (topic, message) => {
    try {
      const data = JSON.parse(message.toString());
      const device = topic.replace("/control", "");
      const led = data.led ?? "-";
      document.getElementById("led_" + device).textContent = led == 1 ? "B·∫≠t" : "T·∫Øt";
      const icon = document.getElementById("icon_" + device);
      if (icon) icon.className = led == 1 ? "fas fa-toggle-on led-icon led-on" : "fas fa-toggle-off led-icon led-off";

      const now = new Date();
      const formatted = now.toLocaleTimeString();
      document.getElementById("time_" + device).textContent = formatted;

      let content = [];

      if (device === "sensor_3") {
        let energy = parseFloat(data.energy ?? 0);
        ["voltage", "current", "power", "energy"].forEach(field => {
          const unit = field === "voltage" ? " V" : field === "current" ? " A" : field === "power" ? " W" : field === "energy" ? " kWh" : "";
          document.getElementById(field + "_" + device).textContent = (data[field] ?? "-") + unit;
          content.push(`${field}: ${data[field]}`);
        });

        const today = new Date();
        const billingDay = 15;
        const billingStart = today.getDate() >= billingDay
          ? new Date(today.getFullYear(), today.getMonth(), billingDay)
          : new Date(today.getFullYear(), today.getMonth() - 1, billingDay);

        const billingEnd = new Date(billingStart);
        billingEnd.setMonth(billingStart.getMonth() + 1);
        document.getElementById("billing_date_sensor_3").textContent =
        billingStart.toLocaleDateString("vi-VN") + " - " + billingEnd.toLocaleDateString("vi-VN");

        const key = `start_energy_${billingStart.toISOString().slice(0, 10)}`;
        let startEnergy = parseFloat(localStorage.getItem(key));
        if (isNaN(startEnergy)) {
          startEnergy = energy;
          localStorage.setItem(key, startEnergy);
        }

        document.getElementById("start_energy_current").textContent = startEnergy.toFixed(2) + " kWh";

        const consumed = energy - startEnergy;
        const billDetail = calculateElectricityCostDetailed(consumed);
        const bill = billDetail.total;

         // üü¢ Ghi v√†o localStorage
        saveCurrentBill(billingStart, consumed, bill, startEnergy);
        function saveCurrentBill(billingStart, consumed, bill, startEnergy) {
          const dateKey = billingStart.toISOString().slice(0, 10);  // yyyy-mm-dd
          const key = `bill_${dateKey}`;
          const value = {
            energy: consumed.toFixed(2),
            bill: Math.round(bill),
            startEnergy: startEnergy.toFixed(2)
          };
          localStorage.setItem(key, JSON.stringify(value));
        }

        const priceDiv = document.getElementById("price_display") || document.createElement("div");
        priceDiv.className = "data-row";
        priceDiv.id = "price_display";
        priceDiv.innerHTML = `<i class="fas fa-money-bill-wave"></i> Ti·ªÅn ƒëi·ªán hi·ªán t·∫°i: <b>${bill.toLocaleString()} ƒë</b>`;
        document.getElementById("box_" + device).appendChild(priceDiv);

        const explainDiv = document.getElementById("explain_display") || document.createElement("div");
        explainDiv.className = "time-row";
        explainDiv.id = "explain_display";
        explainDiv.innerHTML = `Ch·ªâ s·ªë hi·ªán t·∫°i: <b>${energy.toFixed(2)} kWh</b> | 
          Ch·ªâ s·ªë ƒë·∫ßu th√°ng: <b>${startEnergy.toFixed(2)} kWh</b> | 
          ƒê√£ d√πng: <b>${consumed.toFixed(2)} kWh</b> x <b>${(bill / consumed).toFixed(0)} ƒë/kWh</b> = <b>${bill.toLocaleString()} ƒë</b>`;
        document.getElementById("box_" + device).appendChild(explainDiv);
      } else {
        ["moving", "stationary"].forEach(field => {
          document.getElementById(field + "_" + device).textContent = data[field] ?? "-";
          content.push(`${field}: ${data[field]}`);
        });
      }

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${formatted}</td>
        <td>${device}</td>
        <td>${content.map(c => c.split(':')[0]).join(', ')}</td>
        <td>${content.map(c => c.split(': ')[1]).join(' / ')}</td>
        <td>${led == 1 ? 'B·∫≠t' : 'T·∫Øt'}</td>
      `;
      historyTable.appendChild(row);
      historyRows.push([formatted, device, content.join(" | "), led == 1 ? 'B·∫≠t' : 'T·∫Øt']);
      if (historyTable.rows.length > 9) {
        historyTable.deleteRow(0);
        historyRows.shift();
      }

    } catch (err) {
      console.error("L·ªói x·ª≠ l√Ω tin nh·∫Øn:", err);
    }
  });

  function controlLed(topic, state) {
    const payload = JSON.stringify({ led: state });
    client.publish(topic, payload);
  }

  function calculateElectricityCostDetailed(kWh) {
    const steps = [
      { limit: 50, price: 1984 },
      { limit: 50, price: 2050 },
      { limit: 100, price: 2380 },
      { limit: 100, price: 2998 },
      { limit: 100, price: 3350 },
      { limit: Infinity, price: 3460 }
    ];
    let total = 0;
    let breakdown = [];

    for (const step of steps) {
      if (kWh <= 0) break;
      const usage = Math.min(kWh, step.limit);
      const cost = usage * step.price;
      total += cost;
      breakdown.push({ usage, price: step.price, cost });
      kWh -= usage;
    }

    return {
      total: Math.round(total),
      breakdown
    };
  }

  function checkWiFiStatus() {
    fetch("https://www.google.com/favicon.ico", { method: "HEAD", mode: "no-cors" })
      .then(() => {
        wifiStatus.textContent = "\u0110\u00e3 k\u1ebft n\u1ed1i";
        wifiStatus.className = "online";
      })
      .catch(() => {
        wifiStatus.textContent = "M·∫•t k·∫øt n·ªëi";
        wifiStatus.className = "offline";
      });
  }

  function downloadCSV() {
    let csv = "Th·ªùi gian,Thi·∫øt b·ªã,Th√¥ng s·ªë,Gi√° tr·ªã,LED\n";
    historyRows.forEach(row => {
      csv += row.join(",") + "\n";
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "lich_su_du_lieu.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function exportExcelBillToServer() {
  const rows = [["Th√°ng", "S·∫£n l∆∞·ª£ng (kWh)", "Ti·ªÅn ƒëi·ªán (VNƒê)", "Ch·ªâ s·ªë ƒë·∫ßu k·ª≥"]];
  for (let key in localStorage) {
    if (key.startsWith("bill_")) {
      const item = JSON.parse(localStorage.getItem(key));
      const parts = key.split("_");
      const month = `${parts[2]}/${parts[1]}`;
      rows.push([month, item.energy, item.bill, item.startEnergy]);
    }
  }

  const worksheet = XLSX.utils.aoa_to_sheet(rows);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Bill");

  const wbout = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
  const blob = new Blob([wbout], {
    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  });

  const formData = new FormData();
  const now = new Date();
  const filename = `bill_${String(now.getMonth() + 1).padStart(2, '0')}_${now.getFullYear()}.xlsx`;
  formData.append("file", blob, filename);

 fetch("http://localhost/nongtrai.github.io/upload_bill.php", {
  method: "POST",
  body: formData
})
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        alert("‚úî File ƒë√£ l∆∞u v√†o server: " + data.path);
      } else {
        alert("‚ùå L·ªói khi l∆∞u: " + JSON.stringify(data));
      }
    })
    .catch(err => {
      console.error(err);
      alert("‚ùå L·ªói k·∫øt n·ªëi server");
    });
}
  setInterval(checkWiFiStatus, 5000);
  checkWiFiStatus();
</script>
</body>
</html>
