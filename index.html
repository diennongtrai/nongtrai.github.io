<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESP32 MQTT Dashboard</title>
  <style>
    body { font-family: Arial; background: #f0f0f0; padding: 20px; }
    .status { margin-bottom: 20px; }
    .sensor-box {
      background: #fff; padding: 10px; margin-bottom: 10px;
      border-radius: 8px; box-shadow: 0 0 5px #ccc;
      display: flex; justify-content: space-between; align-items: center;
    }
    button { padding: 6px 12px; margin-left: 5px; }
    .led-icon {
      font-size: 24px; margin-left: 10px;
      transition: color 0.3s;
    }
    .led-on { color: gold; }
    .led-off { color: #ccc; }
    .online { color: green; }
    .offline { color: red; }
    canvas {
      background: #fff; padding: 10px;
      margin-top: 20px; border-radius: 8px;
      box-shadow: 0 0 5px #aaa;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <h2>ESP32 Dashboard</h2>

  <div class="status">
    <b>MQTT:</b> <span id="mqttStatus" class="offline">Chưa kết nối</span>
  </div>

  <h3>Điều khiển LED</h3>
  <div class="sensor-box">
    <div>
      Sensor 1:
      <button onclick="controlLed('sensor_1', 1)">Bật</button>
      <button onclick="controlLed('sensor_1', 0)">Tắt</button>
    </div>
    <i id="icon_sensor_1" class="fas fa-lightbulb led-icon led-off"></i>
  </div>

  <div class="sensor-box">
    <div>
      Sensor 2:
      <button onclick="controlLed('sensor_2', 1)">Bật</button>
      <button onclick="controlLed('sensor_2', 0)">Tắt</button>
    </div>
    <i id="icon_sensor_2" class="fas fa-lightbulb led-icon led-off"></i>
  </div>

  <h3>Biểu đồ Sensor 1</h3>
  <canvas id="chart_sensor_1" width="600" height="250"></canvas>

  <h3>Biểu đồ Sensor 2</h3>
  <canvas id="chart_sensor_2" width="600" height="250"></canvas>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const mqttStatus = document.getElementById("mqttStatus");

    const chartData = {
      sensor_1: { labels: [], moving: [], stationary: [] },
      sensor_2: { labels: [], moving: [], stationary: [] }
    };

    const charts = {
      sensor_1: new Chart(document.getElementById("chart_sensor_1").getContext("2d"), {
        type: 'line',
        data: {
          labels: chartData.sensor_1.labels,
          datasets: [
            { label: "Moving", data: chartData.sensor_1.moving, borderColor: "red", fill: false },
            { label: "Stationary", data: chartData.sensor_1.stationary, borderColor: "blue", fill: false }
          ]
        }
      }),
      sensor_2: new Chart(document.getElementById("chart_sensor_2").getContext("2d"), {
        type: 'line',
        data: {
          labels: chartData.sensor_2.labels,
          datasets: [
            { label: "Moving", data: chartData.sensor_2.moving, borderColor: "red", fill: false },
            { label: "Stationary", data: chartData.sensor_2.stationary, borderColor: "blue", fill: false }
          ]
        }
      })
    };

    const client = mqtt.connect("wss://5535a388c0214921bd01737fcf390158.s1.eu.hivemq.cloud:8884/mqtt", {
      username: "Famer_smarthome123",
      password: "@Tmh12345678"
    });

    client.on("connect", () => {
      mqttStatus.textContent = "Đã kết nối";
      mqttStatus.className = "online";
      ["sensor_1", "sensor_2"].forEach(topic => {
        client.subscribe(topic + "/control");
      });
    });

    client.on("message", (topic, message) => {
      const device = topic.replace("/control", "");
      try {
        const data = JSON.parse(message.toString());
        const led = data.led ?? 0;
        const moving = data.moving ?? Math.random() * 10;
        const stationary = data.stationary ?? Math.random() * 5;

        const icon = document.getElementById("icon_" + device);
        if (icon) {
          icon.classList.toggle("led-on", led == 1);
          icon.classList.toggle("led-off", led == 0);
        }

        const time = new Date().toLocaleTimeString();
        if (charts[device]) {
          const d = chartData[device];
          d.labels.push(time);
          d.moving.push(moving);
          d.stationary.push(stationary);
          if (d.labels.length > 20) {
            d.labels.shift(); d.moving.shift(); d.stationary.shift();
          }
          charts[device].update();
        }
      } catch (e) {
        console.error("JSON error:", e);
      }
    });

    function controlLed(topic, state) {
      client.publish(topic, JSON.stringify({ led: state }));
    }
  </script>
</body>
</html>
